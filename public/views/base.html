{% extends "base.html" %}

{% block title %}User Profile{% endblock %}

{% block content %}
<div class="container mt-5 text-light">
    <h2 class="text-center mb-4">User Profile</h2>
    <div id="profile-details" class="mb-4">
        <!-- Details will be populated by JavaScript -->
    </div>

    <h4>Edit Information</h4>
    <form id="update-form" class="mb-4">
        <div class="mb-3">
            <label for="job" class="form-label">Job</label>
            <input type="text" class="form-control" id="job" name="job" required>
        </div>
        <div class="mb-3">
            <label for="country" class="form-label">Country</label>
            <input type="text" class="form-control" id="country" name="country" required>
        </div>
        <button type="submit" class="btn btn-primary">Update Profile</button>
    </form>

    <div id="update-result"></div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const token = localStorage.getItem('token');

    if (!token) {
        window.location.href = "/login";
        return;
    }

    fetch("http://localhost:3000/api/auth/profile", {
        headers: { Authorization: `Bearer ${token}` }
    })
    .then(res => res.json())
    .then(data => {
        const user = data.user;
        localStorage.setItem('user', JSON.stringify(user)); // store for navbar use
        document.getElementById('profile-details').innerHTML = `
            <p><strong>Name:</strong> ${user.name} ${user.second_name || ''} ${user.last_name} ${user.second_lastname || ''}</p>
            <p><strong>Email:</strong> ${user.email}</p>
            <p><strong>Phone:</strong> ${user.phone_number}</p>
            <p><strong>Country:</strong> ${user.country}</p>
            <p><strong>Job:</strong> ${user.job}</p>
        `;

        // Set current job/country values in the form
        document.getElementById('job').value = user.job;
        document.getElementById('country').value = user.country;
    });

    document.getElementById('update-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const user = JSON.parse(localStorage.getItem('user'));
        const updateData = {
            job: document.getElementById('job').value,
            country: document.getElementById('country').value
        };

        const res = await fetch(`http://localhost:3000/api/auth/update/${user._id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${token}`
            },
            body: JSON.stringify(updateData)
        });

        const result = await res.json();
        const message = result.msg || 'Update failed.';
        document.getElementById('update-result').textContent = message;

        if (res.ok) {
            localStorage.setItem('user', JSON.stringify(result.user));
        }
    });
});
</script>
{% endblock %}